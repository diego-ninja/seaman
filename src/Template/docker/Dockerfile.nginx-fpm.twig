FROM php:{{ php.version }}-fpm-alpine

# Install system dependencies
RUN apk add --no-cache \
nginx \
git \
curl \
zip \
unzip \
icu-dev \
libzip-dev \
linux-headers

# Install PHP extensions
RUN docker-php-ext-install \
{% for extension in php.extensions %}
    {{ extension }}{% if not loop.last %} \{% endif %}

{% endfor %}

# Install Xdebug
RUN apk add --no-cache --virtual .build-deps $PHPIZE_DEPS \
&& pecl install xdebug \
&& docker-php-ext-enable xdebug \
&& apk del .build-deps \
&& echo "; xdebug disabled by default" > /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini

# Install Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Copy nginx configuration
COPY .seaman/config/nginx.conf /etc/nginx/nginx.conf

WORKDIR /var/www/html

# Make xdebug-toggle script executable
RUN chmod +x /usr/local/bin/xdebug-toggle || true

CMD sh -c "php-fpm -D && nginx -g 'daemon off;'"