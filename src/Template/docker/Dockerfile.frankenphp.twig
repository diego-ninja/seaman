FROM dunglas/frankenphp:latest-php{{ php.version }}

# Install system dependencies
RUN apt-get update && apt-get install -y \
git \
curl \
zip \
unzip \
libicu-dev \
libzip-dev \
&& rm -rf /var/lib/apt/lists/*

# Install PHP extensions
RUN docker-php-ext-install \
{% for extension in php.extensions %}
    {{ extension }}{% if not loop.last %} \{% endif %}

{% endfor %}

# Install Xdebug
RUN pecl install xdebug \
&& docker-php-ext-enable xdebug \
&& echo "; xdebug disabled by default" > /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini

# Install Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

WORKDIR /var/www/html

# Make xdebug-toggle script executable
RUN chmod +x /usr/local/bin/xdebug-toggle || true

CMD ["frankenphp", "run", "--config", "/etc/caddy/Caddyfile"]