services:
  app:
    image: seaman/seaman-php{{ php_version }}:latest
    container_name: seaman-{{ project_name }}-app
    build:
      context: .
      dockerfile: .seaman/Dockerfile
      args:
        WWWGROUP: ${WWWGROUP:-1000}
        PHP_VERSION: ${PHP_VERSION:-{{ php_version }}}
    volumes:
      - .:/var/www/html
      - .seaman/scripts/xdebug-toggle.sh:/usr/local/bin/xdebug-toggle
    environment:
      - XDEBUG_MODE=${XDEBUG_MODE:-off}
      - PHP_IDE_CONFIG=serverName=seaman
{% if not proxy_enabled %}
    ports:
      - "${APP_PORT:-80}:80"
{% endif %}
{% if services.enabled|length > 0 %}
    depends_on:
{% for name, service in services.enabled %}
      - {{ name }}
{% endfor %}
{% endif %}
{% if proxy_enabled and app_labels|length > 0 %}
    labels:
{% for label in app_labels %}
      - "{{ label }}"
{% endfor %}
{% endif %}
    networks:
      - seaman
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

{% for name, service in services.enabled %}
{% include 'docker/services/' ~ service.config.type.value ~ '.twig' with { name: name, service: service.config, labels: service.labels, proxy_enabled: proxy_enabled, project_name: project_name } %}

{% endfor %}
networks:
  seaman:
    driver: bridge

{% if volumes.persist|length > 0 %}
volumes:
{% for volume in volumes.persist %}
  {{ volume }}:
{% endfor %}
{% endif %}
