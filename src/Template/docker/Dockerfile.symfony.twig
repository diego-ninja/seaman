FROM php:{{ php.version }}-cli-alpine

# Install system dependencies
RUN apk add --no-cache \
git \
curl \
zip \
unzip \
icu-dev \
libzip-dev \
linux-headers

# Install PHP extensions
RUN docker-php-ext-install \
{% for extension in php.extensions %}
    {{ extension }}{% if not loop.last %} \{% endif %}

{% endfor %}

# Install Xdebug (but don't enable by default)
RUN apk add --no-cache --virtual .build-deps $PHPIZE_DEPS \
&& pecl install xdebug \
&& docker-php-ext-enable xdebug \
&& apk del .build-deps \
&& echo "; xdebug disabled by default" > /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini

# Install Composer
COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

# Install Symfony CLI
RUN curl -sS https://get.symfony.com/cli/installer | bash \
&& mv /root/.symfony*/bin/symfony /usr/local/bin/symfony

WORKDIR /var/www/html

# Make xdebug-toggle script executable
RUN chmod +x /usr/local/bin/xdebug-toggle || true

CMD ["symfony", "server:start", "--no-tls", "--port=8000"]