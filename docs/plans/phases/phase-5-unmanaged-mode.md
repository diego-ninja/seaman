# Phase 5: Unmanaged Mode Support - Implementation Plan

**Phase**: 5 of 6
**Goal**: Make commands work without initialization (passthrough mode)
**Dependencies**: Phase 1 (Foundation required)
**Estimated Tasks**: 5 tasks
**Testing Strategy**: Unit tests for logic, manual testing for command behavior

## Overview

This phase enables basic docker-compose commands (start, stop, restart, status, logs, etc.) to work directly with any docker-compose.yaml file without requiring seaman initialization. Commands simply passthrough to docker-compose.

## Prerequisites

- Phase 1 completed (ModeAwareCommand, ModeDetector, OperatingMode)
- All commands already extend ModeAwareCommand
- Working in `.worktrees/dual-mode-traefik-import` branch

## Implementation Tasks

### Task 1: Update DockerManager for Passthrough Mode

**File**: `src/Service/DockerManager.php` (existing, needs update)

**Current State**: Assumes seaman.yaml exists, docker-compose.yml generated by seaman

**Update**: Add mode awareness and passthrough logic

**Changes**:
```php
public function __construct(
    private readonly ModeDetector $modeDetector, // NEW
) {}

public function start(?string $service = null): ProcessResult
{
    $mode = $this->modeDetector->detect();

    // In unmanaged mode, just use docker-compose directly
    if ($mode === OperatingMode::Unmanaged) {
        return $this->executeDockerCompose(['up', '-d', $service]);
    }

    // Managed mode - existing logic
    return $this->executeDockerCompose(['up', '-d', $service]);
}

public function stop(?string $service = null): ProcessResult
{
    $mode = $this->modeDetector->detect();

    if ($mode === OperatingMode::Unmanaged) {
        return $this->executeDockerCompose(['stop', $service]);
    }

    return $this->executeDockerCompose(['stop', $service]);
}

// Similar updates for restart, status, logs, destroy, rebuild, etc.

private function executeDockerCompose(array $args): ProcessResult
{
    // Filter out null args
    $args = array_filter($args, fn($arg) => $arg !== null);

    $command = array_merge(['docker-compose'], $args);

    $process = new Process($command);
    $process->setTimeout($this->getTimeout($args));
    $process->run();

    return new ProcessResult(
        exitCode: $process->getExitCode(),
        output: $process->getOutput(),
        errorOutput: $process->getErrorOutput()
    );
}
```

**Note**: In this case, the logic is actually the same for both modes - just pass through to docker-compose. The mode detection is for future use if we need different behavior.

**Verification**:
```bash
vendor/bin/phpstan analyse src/Service/DockerManager.php
vendor/bin/php-cs-fixer fix src/Service/DockerManager.php
```

---

### Task 2: Update Command supportsMode() Implementations

**Goal**: Ensure all commands have correct mode support

**Commands to Verify/Update**:

**Always Support All Modes** (passthrough to docker-compose):
```php
protected function supportsMode(OperatingMode $mode): bool
{
    return true; // Works in all modes
}
```

Apply to:
- `StartCommand`
- `StopCommand`
- `RestartCommand`
- `StatusCommand`
- `LogsCommand`
- `DestroyCommand`
- `RebuildCommand`
- `ShellCommand`
- `ExecutePhpCommand`
- `ExecuteComposerCommand`
- `ExecuteConsoleCommand`

**Managed Mode Only** (requires seaman.yaml):
```php
protected function supportsMode(OperatingMode $mode): bool
{
    return $mode === OperatingMode::Managed;
}
```

Apply to:
- `XdebugOnCommand`
- `XdebugOffCommand`
- `ServiceAddCommand`
- `ServiceRemoveCommand`
- `ServiceListCommand` (for now, could be enhanced in future)
- `DevContainerGenerateCommand`
- `ProxyConfigureDnsCommand`

**Database Commands** (support all modes for now, future: fuzzy detection):
```php
protected function supportsMode(OperatingMode $mode): bool
{
    return true; // Support all modes (will attempt to detect db service)
}
```

Apply to:
- `DbDumpCommand`
- `DbRestoreCommand`
- `DbShellCommand`

**Verification** (for each command):
```bash
vendor/bin/phpstan analyse src/Command/<CommandName>.php
```

---

### Task 3: Add Helpful Upgrade Messages

**Goal**: When unmanaged commands show limited functionality, suggest upgrading

**Update** `ModeAwareCommand::showUpgradeMessage()`:
```php
protected function showUpgradeMessage(SymfonyStyle $io): void
{
    $io->warning('This command requires seaman initialization.');
    $io->writeln('');
    $io->writeln('Run <info>seaman init</info> to unlock full features:');
    $io->listing([
        'Service management (add/remove services)',
        'Xdebug control',
        'DevContainer generation',
        'Advanced database tools',
        'Traefik reverse proxy with HTTPS',
        'Automatic service routing',
    ]);
    $io->writeln('');
    $io->writeln('Or use <info>seaman init --import</info> to import your existing docker-compose.yaml');
}
```

**Verification**:
```bash
vendor/bin/phpstan analyse src/Command/ModeAwareCommand.php
```

---

### Task 4: Test Unmanaged Mode Manually

**Goal**: Verify all passthrough commands work without seaman.yaml

**Test Scenario**:

1. Create test directory with only docker-compose.yml (no seaman):
```bash
mkdir /tmp/seaman-unmanaged-test
cd /tmp/seaman-unmanaged-test
```

2. Create minimal docker-compose.yml:
```yaml
version: '3.8'
services:
  postgres:
    image: postgres:16
    ports:
      - "5432:5432"
    environment:
      POSTGRES_PASSWORD: secret

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

3. Test commands:
```bash
# Should work (passthrough)
seaman start
seaman status
seaman logs postgres
seaman stop
seaman restart
seaman destroy

# Should show upgrade message
seaman service:add mysql
seaman xdebug:on
seaman devcontainer:generate
```

4. Document results in TESTING.md

**Expected Behavior**:
- Basic commands work (start/stop/status/logs/destroy/rebuild)
- Managed-only commands show helpful upgrade message
- No errors, clean user experience

---

### Task 5: Update Application Help Text

**Goal**: Make it clear which commands work in unmanaged mode

**File**: `src/Application.php` or individual commands

**Update command descriptions** to indicate mode requirements:

```php
// Example: ServiceAddCommand
$this->setDescription('Add services to seaman configuration')
     ->setHelp('Requires seaman initialization. Run "seaman init" first.');

// Example: StartCommand
$this->setDescription('Start Docker services')
     ->setHelp('Works with any docker-compose.yml file. Run "seaman init" for full features.');
```

**Verification**:
```bash
seaman list
# Review command descriptions

seaman start --help
# Check help text

seaman service:add --help
# Check help text mentions requirement
```

---

## Final Phase 5 Verification

After all tasks complete:

```bash
# Test in unmanaged mode
cd /tmp/seaman-unmanaged-test
seaman start
seaman status
seaman logs
seaman stop

# Test managed-only commands show upgrade message
seaman service:add mysql
# Should show clear message about needing init

# Test in managed mode (existing seaman project)
cd ~/my-seaman-project
seaman start
seaman service:add mysql
# Should work normally

# Run PHPStan
vendor/bin/phpstan analyse

# Run PHP CS Fixer
vendor/bin/php-cs-fixer fix
```

## Manual Test Matrix

| Command | Unmanaged | Managed | Notes |
|---------|-----------|---------|-------|
| `start` | ‚úÖ Works | ‚úÖ Works | Passthrough |
| `stop` | ‚úÖ Works | ‚úÖ Works | Passthrough |
| `restart` | ‚úÖ Works | ‚úÖ Works | Passthrough |
| `status` | ‚úÖ Works | ‚úÖ Works | Passthrough |
| `logs` | ‚úÖ Works | ‚úÖ Works | Passthrough |
| `shell` | ‚úÖ Works | ‚úÖ Works | Passthrough |
| `destroy` | ‚úÖ Works | ‚úÖ Works | Passthrough |
| `rebuild` | ‚úÖ Works | ‚úÖ Works | Passthrough |
| `execute:php` | ‚úÖ Works | ‚úÖ Works | Passthrough |
| `execute:composer` | ‚úÖ Works | ‚úÖ Works | Passthrough |
| `execute:console` | ‚úÖ Works | ‚úÖ Works | Passthrough |
| `db:dump` | ‚úÖ Works* | ‚úÖ Works | *If service detectable |
| `db:restore` | ‚úÖ Works* | ‚úÖ Works | *If service detectable |
| `db:shell` | ‚úÖ Works* | ‚úÖ Works | *If service detectable |
| `service:add` | ‚ùå Upgrade msg | ‚úÖ Works | Managed only |
| `service:remove` | ‚ùå Upgrade msg | ‚úÖ Works | Managed only |
| `service:list` | ‚ùå Upgrade msg | ‚úÖ Works | Managed only |
| `xdebug:on` | ‚ùå Upgrade msg | ‚úÖ Works | Managed only |
| `xdebug:off` | ‚ùå Upgrade msg | ‚úÖ Works | Managed only |
| `devcontainer:generate` | ‚ùå Upgrade msg | ‚úÖ Works | Managed only |
| `proxy:configure-dns` | ‚ùå Upgrade msg | ‚úÖ Works | Managed only |
| `init` | ‚úÖ Works | ‚úÖ Works | Creates managed mode |

## Commit Strategy

This phase is lighter on code changes (mostly verification and testing):

```bash
git add <files>
git commit -m "feat(unmanaged): enable basic commands without initialization

Support passthrough docker-compose commands in unmanaged mode.
Commands work with any docker-compose.yaml file without seaman init.

Updated:
- DockerManager for mode-aware execution
- All commands with correct supportsMode() implementation
- Upgrade messages for managed-only features
- Help text to indicate mode requirements

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"
```

## Success Criteria

- ‚úÖ All 5 tasks completed
- ‚úÖ Basic commands work without seaman.yaml
- ‚úÖ Managed-only commands show helpful upgrade messages
- ‚úÖ No errors in unmanaged mode
- ‚úÖ Clear value proposition for upgrading to managed mode
- ‚úÖ PHPStan level 10 clean
- ‚úÖ Manual test matrix completed

## Next Phase

After Phase 5 completion:
- Phase 6: Testing & Documentation
- Document: `docs/plans/phases/phase-6-testing-documentation.md`
